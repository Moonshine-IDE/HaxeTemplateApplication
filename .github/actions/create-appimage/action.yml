name: 'Create AppImage'
description: 'Creates an AppImage from binaries and resources'
inputs:
  app-name:
    description: 'Name of the application'
    required: true
  app-version:
    description: 'Version of the application'
    required: true
  app-icon-name:
    description: 'Path to the application icon'
    required: true
  app-categories:
    description: 'Comma-separated list of categories'
    required: true
  bin-paths:
    description: 'Comma-separated paths to the binaries'
    required: true
  lib-paths:
    description: 'Comma-separated paths to the libraries'
    required: true
  resource-paths:
    description: 'Comma-separated paths to other resources that go into the AppDir'
    required: true
  

runs:
  using: 'composite'
  steps:

    - name: Install dependencies
      run: sudo apt-get install -y libfuse2
      shell: bash

    - name: Download AppImageTool
      run: |
        wget "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod a+x appimagetool-x86_64.AppImage
      shell: bash

    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib

        IFS=',' read -ra ADDR <<< "${{ inputs.bin-paths }}"
        for binary in "${ADDR[@]}"; do 
          cp $binary AppDir/usr/bin; 
        done

        IFS=',' read -ra ADDR <<< "${{ inputs.lib-paths }}"
        for lib in "${ADDR[@]}"; 
          do cp -r $lib AppDir/usr/lib; 
        done

        IFS=',' read -ra ADDR <<< "${{ inputs.resource-paths }}"
        for resource in "${ADDR[@]}"; do 
          cp -r $resource AppDir/; 
        done
      shell: bash

    # - name: Create Desktop file
    #   shell: bash
    #   run: |
    #   echo "[Desktop Entry]
    #     Name=${{ inputs.app-name }}
    #     Exec=${{ inputs.app-name }}
    #     Icon=${{ inputs.app-icon-name }}
    #     Type=Application
    #     Categories=${{ inputs.app-categories }}
    #     X-AppImage-Name=${{ inputs.app-name }}
    #     X-AppImage-Version=${{ inputs.app-version }}
    #     X-AppImage-Arch=x86-64;" > AppDir/${{ inputs.app-name }}.desktop

    # - name: Create AppRun
    #   shell: bash
    #   run: |
    #     echo "#!/bin/bash
    #     HERE=\$(dirname \"\$(readlink -f \"\${0}\")\")
    #     \$HERE/usr/bin/${{ inputs.app-name }}" > AppDir/AppRun
    #   shell: bash      

    - name: Debug output
      run: |
        tree AppDir
        echo Desktop:
        cat AppDir/${{ inputs.app-name }}.desktop
        echo
        echo AppRun:
        cat AppDir/AppRun
      shell: bash